<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; /* å¾®ä¿¡é£æ ¼å­—ä½“ */
            color: #333;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #e5e5e5, #cfd8dc);
        }
        .container {
            padding: 20px;
            max-width: 100%;
            overflow-x: auto;
            background-color: #f7f7f7;
            border-radius: 10px;
            margin: 20px auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #444;
        }
        .button-group, .input-group {
            margin-bottom: 20px;
        }
        .grid-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px;
            max-width: 100%;
            border-radius: 10px; /* åœ†è§’ */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* é˜´å½±æ•ˆæœ */
        }
        .grid {
            display: grid;
            gap: 1px;
            background: #ddd;
            padding: 2px;
            max-width: 1000px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .cell {
            position: relative; /* æ·»åŠ ç›¸å¯¹å®šä½ */
            min-width: 10px;
            min-height: 10px;
            width: calc(min(40px, 1000px / var(--cols)));
            height: calc(min(40px, 1000px / var(--rows)));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            font-size: calc(min(16px, 25px / var(--cols)));
            border-radius: 5px; /* åœ†è§’ */
        }
        .wall {
            background-image: url('img/qiangbi.png');
            background-size: cover;
        }
        .path {
            background-image: url('img/caoping.png');
            background-size: cover;
        }
        .start { background: #FFEB3B; }
        .end { background: #F44336; }
        .expand-btn {
            position: absolute;
            width: 30px; /* å‡å°æŒ‰é’®å¤§å° */
            height: 30px;
            background: #2196F3;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            border-radius: 15px; /* åœ†è§’ */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* é˜´å½±æ•ˆæœ */
        }
        .export-panel {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            max-width: 100%;
            overflow-x: auto;
            background-color: #fff; /* å¾®ä¿¡é£æ ¼èƒŒæ™¯è‰² */
            border-radius: 10px; /* åœ†è§’ */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* é˜´å½±æ•ˆæœ */
        }
        .tag-group {
            margin-bottom: 20px;
        }
        button {
            background: linear-gradient(135deg, #1AAD19, #179b16);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background: linear-gradient(135deg, #179b16, #1AAD19);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .bush {
            background-image: url('img/caoping.png'), url('img/caocong.png');
            background-size: cover, contain;
            background-position: center, center;
            background-repeat: no-repeat, no-repeat;
        }
        .tag-marker {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 15px;
            height: 15px;
            background-color: #2E7D32; /* æ·±ç»¿è‰² */
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            z-index: 2;
        }
        .bush-image {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background-image: url('img/caocong.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            transform: translate(-50%, -50%);
            z-index: 1;
        }
        .duelist {
            background-image: url('img/caoping.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .duelist-image {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background-image: url('img/man.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            transform: translate(-50%, -50%);
            z-index: 1;
        }
        .duelist-marker {
            position: absolute;
            top: 0;
            left: 0;
            width: 15px;
            height: 15px;
            background-color: red;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            z-index: 2;
        }
        .slow {
            background-image: url('img/caoping.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .slow-marker {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: orange;
            color: white;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        .eyes {
            background-image: url('img/caoping.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .eyes-marker {
            position: absolute;
            top: 0;
            left: 0;
            width: 15px;
            height: 15px;
            background-color: blue; /* è“è‰² */
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            z-index: 2;
        }
        .eyes-image {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background-image: url('img/eyes.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            transform: translate(-50%, -50%);
            z-index: 1;
        }
        #slowModeToggle {
            background: linear-gradient(135deg, orange, darkorange);
        }
        #bushModeToggle {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
        }
        #duelistModeToggle {
            background: linear-gradient(135deg, red, darkred);
        }
        #eyesModeToggle {
            background: linear-gradient(135deg, blue, darkblue);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="button-group">
        <div class="section-title">ç½‘æ ¼æ“ä½œ</div>
        <button onclick="initGrid(3,3)">åˆå§‹åŒ–3x3ç½‘æ ¼</button>
        <button onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
        <input type="text" id="importData" placeholder="ç²˜è´´mapæ•°æ®">
        <button onclick="importData()">å¯¼å…¥æ•°æ®</button>
    </div>
    <div class="input-group">
        <div class="section-title">åæ ‡è®¾ç½®</div>
        <input type="text" id="startCoord" placeholder="èµ·ç‚¹åæ ‡ (x,y)">
        <input type="text" id="endCoord" placeholder="ç»ˆç‚¹åæ ‡ (x,y)">
        <button onclick="locatePoints()">å®šä½åæ ‡</button>
    </div>
    <div class="tag-group">
        <div class="section-title">æ¨¡å¼åˆ‡æ¢</div>
        <button id="slowModeToggle" onclick="toggleSlowMode()">æ…¢è¡Œæ¨¡å¼</button>
        <button id="bushModeToggle" onclick="toggleBushMode()">è‰ä¸›æ¨¡å¼</button>
        <button id="duelistModeToggle" onclick="toggleDuelistMode()">å†³æ–—è€…æ¨¡å¼</button>
        <button id="eyesModeToggle" onclick="toggleEyesMode()">çœ¼ç›æ¨¡å¼</button>
    </div>
    <div class="grid-wrapper" id="gridWrapper">
        <div class="grid" id="grid"></div>
        <div class="expand-btn" style="top:-45px;left:50%" onclick="expandGrid('top')">â†‘</div>
        <div class="expand-btn" style="bottom:-45px;left:50%" onclick="expandGrid('bottom')">â†“</div>
        <div class="expand-btn" style="left:-45px;top:50%" onclick="expandGrid('left')">â†</div>
        <div class="expand-btn" style="right:-45px;top:50%" onclick="expandGrid('right')">â†’</div>
    </div>
    <div class="export-panel">
        <div class="section-title">å¯¼å‡ºç»“æœ</div>
        <pre id="output"></pre>
    </div>
</div>

<script>
    let mapState = { start: null, end: null };
    let slowMode = false;
    let bushMode = false;
    let duelistMode = false;
    let eyesMode = false;

    // åˆå§‹åŒ–ç½‘æ ¼
    function initGrid(rows=5, cols=5) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

        // è®¾ç½®CSSå˜é‡
        grid.style.setProperty('--cols', cols);
        grid.style.setProperty('--rows', rows);

        for(let y=0; y<rows; y++) {
            for(let x=0; x<cols; x++) {
                createCell(x, y);
            }
        }
    }

    // åˆ›å»ºå•å…ƒæ ¼
    function createCell(x, y) {
        const cell = document.createElement('div');
        cell.className = 'cell wall';
        cell.dataset.x = x;
        cell.dataset.y = y;
        cell.dataset.state = 'wall';
        cell.onclick = () => cycleState(cell);
        document.getElementById('grid').appendChild(cell);
    }

    // çŠ¶æ€å¾ªç¯åˆ‡æ¢
    function cycleState(cell) {
        if (slowMode && cell.dataset.state === 'path') {
            if (!cell.querySelector('.slow-marker')) {
                const marker = document.createElement('div');
                marker.className = 'slow-marker';
                marker.style.position = 'absolute';
                marker.style.top = '0';
                marker.style.right = '0';
                marker.style.width = '10px';
                marker.style.height = '10px';
                marker.style.backgroundColor = 'orange';
                marker.style.color = 'white';
                marker.style.fontSize = '8px';
                marker.style.display = 'flex';
                marker.style.alignItems = 'center';
                marker.style.justifyContent = 'center';
                marker.textContent = '!';
                cell.appendChild(marker);
                cell.dataset.state = 'slow';
            }
            return;
        }
        if (bushMode && cell.dataset.state === 'path') {
            if (!cell.querySelector('.tag-marker')) {
                const tagMarker = document.createElement('div');
                tagMarker.className = 'tag-marker';
                tagMarker.textContent = '?';
                cell.appendChild(tagMarker);
                cell.dataset.state = 'bush';
                cell.classList.add('bush');

                // æ·»åŠ è‰ä¸›å›¾ç‰‡
                const bushImage = document.createElement('div');
                bushImage.className = 'bush-image';
                cell.appendChild(bushImage);
            } else {
                const tagMarker = cell.querySelector('.tag-marker');
                if (tagMarker) {
                    cell.removeChild(tagMarker);
                }
                const bushImage = cell.querySelector('.bush-image');
                if (bushImage) {
                    cell.removeChild(bushImage);
                }
                cell.dataset.state = 'path';
                cell.classList.remove('bush');
            }
            return;
        }
        if (duelistMode && cell.dataset.state === 'path') {
            if (!cell.querySelector('.duelist-marker')) {
                const duelistMarker = document.createElement('div');
                duelistMarker.className = 'duelist-marker';
                duelistMarker.textContent = 'F';
                cell.appendChild(duelistMarker);
                cell.dataset.state = 'duelist';
                cell.classList.add('duelist');

                // æ·»åŠ äººç‰©å›¾ç‰‡
                const duelistImage = document.createElement('div');
                duelistImage.className = 'duelist-image';
                cell.appendChild(duelistImage);
            } else {
                const duelistMarker = cell.querySelector('.duelist-marker');
                if (duelistMarker) {
                    cell.removeChild(duelistMarker);
                }
                const duelistImage = cell.querySelector('.duelist-image');
                if (duelistImage) {
                    cell.removeChild(duelistImage);
                }
                cell.dataset.state = 'path';
                cell.classList.remove('duelist');
            }
            return;
        }
        if (eyesMode && cell.dataset.state === 'path') {
            if (!cell.querySelector('.eyes-marker')) {
                const eyesMarker = document.createElement('div');
                eyesMarker.className = 'eyes-marker';
                eyesMarker.textContent = 'ğŸ‘';
                cell.appendChild(eyesMarker);
                cell.dataset.state = 'eyes';
                cell.classList.add('eyes');

                // æ·»åŠ çœ¼ç›å›¾ç‰‡
                const eyesImage = document.createElement('div');
                eyesImage.className = 'eyes-image';
                cell.appendChild(eyesImage);
            } else {
                const eyesMarker = cell.querySelector('.eyes-marker');
                if (eyesMarker) {
                    cell.removeChild(eyesMarker);
                }
                const eyesImage = cell.querySelector('.eyes-image');
                if (eyesImage) {
                    cell.removeChild(eyesImage);
                }
                cell.dataset.state = 'path';
                cell.classList.remove('eyes');
            }
            return;
        }
        const states = ['wall', 'path', 'start', 'end'];
        const current = cell.dataset.state;
        const next = states[(states.indexOf(current)+1)%4];

        // æ¸…é™¤ä¹‹å‰çš„æ–‡æœ¬å†…å®¹
        cell.textContent = '';

        // å¦‚æœè¦æ”¹å˜ä¸ºpathï¼ˆç»¿è‰²ï¼‰ï¼Œè¿›è¡Œç‰¹æ®Šå¤„ç†
        if (next === 'path') {
            const x = parseInt(cell.dataset.x);
            const y = parseInt(cell.dataset.y);

            // æ£€æŸ¥æ˜¯å¦æœ‰ç›´æ¥ç›¸é‚»çš„ç»¿è‰²å—
            const hasAdjacentPath = [
                getCell(x-1, y),
                getCell(x+1, y),
                getCell(x, y-1),
                getCell(x, y+1)
            ].some(adjacentCell => adjacentCell?.dataset.state === 'path');

            if (hasAdjacentPath) {
                // å¦‚æœæœ‰ç›¸é‚»çš„ç»¿è‰²å—ï¼Œç›´æ¥è®¾ç½®ä¸ºç»¿è‰²ï¼Œä¸åšå»¶ä¼¸
                cell.dataset.state = 'path';
                cell.className = 'cell path';
                return;
            } else {
                // å¦‚æœæ²¡æœ‰ç›¸é‚»çš„ç»¿è‰²å—ï¼Œå°è¯•å»¶ä¼¸
                const extended = fillContinuousBlocks(x, y);
                if (extended) {
                    return; // å¦‚æœå·²ç»å»¶ä¼¸äº†ï¼Œç›´æ¥è¿”å›
                }
                // å¦‚æœæ²¡æœ‰å»¶ä¼¸ï¼Œç»§ç»­æ‰§è¡Œæ™®é€šçš„çŠ¶æ€åˆ‡æ¢
            }
        }

        // å¤„ç†èµ·ç‚¹çŠ¶æ€
        if(next === 'start') {
            if(mapState.start) {
                const oldStart = document.querySelector(`[data-x="${mapState.start.x}"][data-y="${mapState.start.y}"]`);
                if(oldStart) {
                    oldStart.dataset.state = 'wall';
                    oldStart.className = 'cell wall';
                    oldStart.textContent = '';
                }
            }
            mapState.start = {x: +cell.dataset.x, y: +cell.dataset.y};
        } else if(current === 'start') {
            mapState.start = null;
        }

        // å¤„ç†ç»ˆç‚¹çŠ¶æ€
        if(next === 'end') {
            if(mapState.end) {
                const oldEnd = document.querySelector(`[data-x="${mapState.end.x}"][data-y="${mapState.end.y}"]`);
                if(oldEnd) {
                    oldEnd.dataset.state = 'wall';
                    oldEnd.className = 'cell wall';
                    oldEnd.textContent = '';
                }
            }
            mapState.end = {x: +cell.dataset.x, y: +cell.dataset.y};
        } else if(current === 'end') {
            mapState.end = null;
        }

        // è®¾ç½®æ–°çŠ¶æ€
        cell.dataset.state = next;
        cell.className = `cell ${next}`;
        if(next === 'start') cell.textContent = 'S';
        if(next === 'end') cell.textContent = 'E';

        if (cell.dataset.state === 'slow') {
            const marker = cell.querySelector('.slow-marker');
            if (marker) {
                cell.removeChild(marker);
            }
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–æŒ‡å®šåæ ‡çš„å•å…ƒæ ¼
    function getCell(x, y) {
        return document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
    }

    // å¡«å……Xå’ŒYè½´ä¸Šçš„è¿ç»­å—
    function fillContinuousBlocks(startX, startY) {
        const grid = document.getElementById('grid');
        const cols = parseInt(grid.style.gridTemplateColumns.match(/repeat\((\d+)/)[1]);
        const rows = parseInt(grid.style.gridTemplateRows.match(/repeat\((\d+)/)[1]);

        // åœ¨Xè½´ä¸Šå¯»æ‰¾æœ€è¿‘çš„ç»¿è‰²å—
        let nearestLeft = -1, nearestRight = -1;
        // å‘å·¦æ‰¾
        for(let x = startX - 1; x >= 0; x--) {
            if(getCell(x, startY)?.dataset.state === 'path') {
                nearestLeft = x;
                break;
            }
        }
        // å‘å³æ‰¾
        for(let x = startX + 1; x < cols; x++) {
            if(getCell(x, startY)?.dataset.state === 'path') {
                nearestRight = x;
                break;
            }
        }

        // åœ¨Yè½´ä¸Šå¯»æ‰¾æœ€è¿‘çš„ç»¿è‰²å—
        let nearestTop = -1, nearestBottom = -1;
        // å‘ä¸Šæ‰¾
        for(let y = startY - 1; y >= 0; y--) {
            if(getCell(startX, y)?.dataset.state === 'path') {
                nearestTop = y;
                break;
            }
        }
        // å‘ä¸‹æ‰¾
        for(let y = startY + 1; y < rows; y++) {
            if(getCell(startX, y)?.dataset.state === 'path') {
                nearestBottom = y;
                break;
            }
        }

        let hasExtended = false;

        // å¡«å……Xè½´ä¸Šçš„è¿æ¥çº¿
        if(nearestLeft !== -1) {
            for(let x = nearestLeft + 1; x <= startX; x++) {
                const cell = getCell(x, startY);
                if(cell && cell.dataset.state === 'wall') {
                    cell.dataset.state = 'path';
                    cell.className = 'cell path';
                    hasExtended = true;
                }
            }
        }
        if(nearestRight !== -1) {
            for(let x = startX; x <= nearestRight - 1; x++) {
                const cell = getCell(x, startY);
                if(cell && cell.dataset.state === 'wall') {
                    cell.dataset.state = 'path';
                    cell.className = 'cell path';
                    hasExtended = true;
                }
            }
        }

        // å¡«å……Yè½´ä¸Šçš„è¿æ¥çº¿
        if(nearestTop !== -1) {
            for(let y = nearestTop + 1; y <= startY; y++) {
                const cell = getCell(startX, y);
                if(cell && cell.dataset.state === 'wall') {
                    cell.dataset.state = 'path';
                    cell.className = 'cell path';
                    hasExtended = true;
                }
            }
        }
        if(nearestBottom !== -1) {
            for(let y = startY; y <= nearestBottom - 1; y++) {
                const cell = getCell(startX, y);
                if(cell && cell.dataset.state === 'wall') {
                    cell.dataset.state = 'path';
                    cell.className = 'cell path';
                    hasExtended = true;
                }
            }
        }

        return hasExtended;
    }
    function exportData() {
        const grid = document.getElementById('grid');
        const cols = parseInt(grid.style.gridTemplateColumns.match(/repeat\((\d+)/)[1]);
        const rows = parseInt(grid.style.gridTemplateRows.match(/repeat\((\d+)/)[1]);
        const map = [];

        for(let x = 0; x < cols; x++) {
            const row = [];
            for(let y = rows - 1; y >= 0; y--) {
                const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                let value = -1;
                if (cell.dataset.state === 'path') {
                    value = 1;
                } else if (cell.dataset.state === 'slow') {
                    value = 2;
                } else if (cell.dataset.state === 'bush') {
                    value = 3;
                } else if (cell.dataset.state === 'duelist') {
                    value = -2;
                } else if (cell.dataset.state === 'eyes') {
                    value = 4;
                }
                row.push(`"${value}"`);
            }
            map.push(row);
        }

        // è°ƒæ•´åæ ‡è½¬æ¢é€»è¾‘
        let startPoint = mapState.start ?
            `Array(${mapState.start.x},${rows - 1 - mapState.start.y})` : 'Array(0,0)';
        let endPoint = mapState.end ?
            `Array(${mapState.end.x},${rows - 1 - mapState.end.y})` : 'Array(0,0)';

        const output = `åœ°å›¾ä¿¡æ¯:\nDim map= Array(${map.map(r => `Array(${r.join(',')})`).join(',')})\n\n` +
                       `åæ ‡ä¿¡æ¯:\nDim startPoint = ${startPoint}\n` +
                       `Dim endPoint = ${endPoint}`;

        document.getElementById('output').textContent = output;
    }
    function importData() {
        const input = document.getElementById('importData').value;

        // è§£æåœ°å›¾æ•°æ®
        const mapStringMatch = input.match(/Array\((Array\([\s\S]*?\))\)/);
        if (!mapStringMatch) {
            console.error('Invalid map data format');
            return;
        }
        const mapString = mapStringMatch[1];
        const mapData = mapString.split('Array(')
            .filter(row => row.length > 0)
            .map(row => {
                return row.replace(/\)$|\),/g, '')
                    .split(',')
                    .map(str => {
                        const numStr = str.replace(/"/g, '').trim();
                        return parseInt(numStr);
                    });
            });

        if (mapData.length > 0) {
            const rows = mapData[0].length;  // æ³¨æ„ï¼šè¿™é‡Œäº¤æ¢äº†è¡Œåˆ—
            const cols = mapData.length;

            // åˆå§‹åŒ–ç½‘æ ¼
            initGrid(rows, cols);

            // æ¸…é™¤ç½‘æ ¼
            document.getElementById('grid').innerHTML = '';

            // é‡æ–°åˆ›å»ºç½‘æ ¼å¹¶è®¾ç½®æ­£ç¡®çš„çŠ¶æ€
            for(let y = 0; y < rows; y++) {
                for(let x = 0; x < cols; x++) {
                    const cell = document.createElement('div');
                    const cellValue = mapData[x][rows - 1 - y];
                    let state = 'wall';
                    if (cellValue === 1) {
                        state = 'path';
                    } else if (cellValue === 2) {
                        state = 'slow';
                        cell.classList.add('path'); // è®¾ç½®ä¸ºç»¿è‰²
                        cell.classList.add('slow');
                        // æ·»åŠ æ…¢è¡Œæ ‡è®°
                        const marker = document.createElement('div');
                        marker.className = 'slow-marker';
                        marker.style.position = 'absolute';
                        marker.style.top = '0';
                        marker.style.right = '0';
                        marker.style.width = '10px';
                        marker.style.height = '10px';
                        marker.style.backgroundColor = 'orange';
                        marker.style.color = 'white';
                        marker.style.fontSize = '8px';
                        marker.style.display = 'flex';
                        marker.style.alignItems = 'center';
                        marker.style.justifyContent = 'center';
                        marker.textContent = '!';
                        cell.appendChild(marker);
                    } else if (cellValue === 3) {
                        state = 'bush';
                        const tagMarker = document.createElement('div');
                        tagMarker.className = 'tag-marker';
                        tagMarker.textContent = '?';
                        cell.appendChild(tagMarker);
                        cell.classList.add('bush');

                        // æ·»åŠ è‰ä¸›å›¾ç‰‡
                        const bushImage = document.createElement('div');
                        bushImage.className = 'bush-image';
                        cell.appendChild(bushImage);
                    } else if (cellValue === -2) {
                        state = 'duelist';
                        const duelistMarker = document.createElement('div');
                        duelistMarker.className = 'duelist-marker';
                        duelistMarker.textContent = 'F';
                        cell.appendChild(duelistMarker);
                        cell.classList.add('duelist');

                        // æ·»åŠ äººç‰©å›¾ç‰‡
                        const duelistImage = document.createElement('div');
                        duelistImage.className = 'duelist-image';
                        cell.appendChild(duelistImage);
                    } else if (cellValue === 4) {
                        state = 'eyes';
                        const eyesMarker = document.createElement('div');
                        eyesMarker.className = 'eyes-marker';
                        eyesMarker.textContent = 'ğŸ‘';
                        cell.appendChild(eyesMarker);
                        cell.classList.add('eyes');

                        // æ·»åŠ çœ¼ç›å›¾ç‰‡
                        const eyesImage = document.createElement('div');
                        eyesImage.className = 'eyes-image';
                        cell.appendChild(eyesImage);
                    }
                    cell.className = `cell ${state}`;
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.dataset.state = state;
                    cell.onclick = () => cycleState(cell);
                    document.getElementById('grid').appendChild(cell);
                }
            }

            // å¤„ç†èµ·ç‚¹ç»ˆç‚¹åæ ‡
            const startMatch = input.match(/startPoint = Array\((.*?)\)/);
            const endMatch = input.match(/endPoint = Array\((.*?)\)/);

            if(startMatch && endMatch) {
                const [_, inputX, inputY] = startMatch[1].split(',').map(Number);
                const [endY, endX] = endMatch[1].split(',').map(Number);

                // æ‰¾åˆ°å¯¹åº”çš„å•å…ƒæ ¼å¹¶è®¾ç½®çŠ¶æ€
                const startCell = document.querySelector(`[data-x="${startX}"][data-y="${startY}"]`);
                const endCell = document.querySelector(`[data-x="${endX}"][data-y="${endY}"]`);

                if(startCell) {
                    startCell.dataset.state = 'start';
                    startCell.className = 'cell start';
                    startCell.textContent = 'S';
                    mapState.start = {x: startX, y: startY};
                }

                if(endCell) {
                    endCell.dataset.state = 'end';
                    endCell.className = 'cell end';
                    endCell.textContent = 'E';
                    mapState.end = {x: endX, y: endY};
                }
            }
        }
    }
    function expandGrid(direction) {
        const grid = document.getElementById('grid');
        const cols = parseInt(grid.style.gridTemplateColumns.match(/repeat\((\d+)/)[1]);
        const rows = parseInt(grid.style.gridTemplateRows.match(/repeat\((\d+)/)[1]);

        // é‡æ–°æ’åˆ—æ‰€æœ‰å•å…ƒæ ¼çš„åæ ‡
        function reorderCells() {
            const cells = Array.from(document.querySelectorAll('.cell'));
            const cellMap = new Map();

            // å…ˆä¿å­˜æ‰€æœ‰å•å…ƒæ ¼çš„çŠ¶æ€å’Œæ ‡ç­¾
            cells.forEach(cell => {
                const x = parseInt(cell.dataset.x);
                const y = parseInt(cell.dataset.y);
                const state = cell.dataset.state;
                const hasTagMarker = cell.querySelector('.tag-marker') !== null;
                const hasSlowMarker = cell.querySelector('.slow-marker') !== null;
                const hasDuelistMarker = cell.querySelector('.duelist-marker') !== null;
                const hasEyesMarker = cell.querySelector('.eyes-marker') !== null;
                const hasBushImage = cell.querySelector('.bush-image') !== null;
                const hasDuelistImage = cell.querySelector('.duelist-image') !== null;
                const hasEyesImage = cell.querySelector('.eyes-image') !== null;
                cellMap.set(`${x},${y}`, { state, hasTagMarker, hasSlowMarker, hasDuelistMarker, hasEyesMarker, hasBushImage, hasDuelistImage, hasEyesImage });
            });

            // æ¸…ç©ºç½‘æ ¼
            grid.innerHTML = '';

            // é‡æ–°åˆ›å»ºæ‰€æœ‰å•å…ƒæ ¼
            const newRows = direction === 'top' || direction === 'bottom' ? rows + 1 : rows;
            const newCols = direction === 'left' || direction === 'right' ? cols + 1 : cols;

            for(let y = 0; y < newRows; y++) {
                for(let x = 0; x < newCols; x++) {
                    let state = 'wall';
                    let actualX = x;
                    let actualY = y;

                    // æ ¹æ®æ‰©å±•æ–¹å‘è°ƒæ•´åæ ‡
                    switch(direction) {
                        case 'top':
                            actualY = y - 1;
                            break;
                        case 'left':
                            actualX = x - 1;
                            break;
                    }

                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŸæœ‰çŠ¶æ€å’Œæ ‡ç­¾
                    const existingCell = cellMap.get(`${actualX},${actualY}`);
                    if (existingCell) {
                        state = existingCell.state;
                    }

                    const cell = document.createElement('div');
                    cell.className = `cell ${state}`;
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.dataset.state = state;
                    cell.onclick = () => cycleState(cell);

                    if (state === 'start') cell.textContent = 'S';
                    if (state === 'end') cell.textContent = 'E';

                    // æ¢å¤æ ‡ç­¾å’Œæ ·å¼
                    if (existingCell) {
                        if (existingCell.hasTagMarker) {
                            const tagMarker = document.createElement('div');
                            tagMarker.className = 'tag-marker';
                            tagMarker.textContent = '?';
                            cell.appendChild(tagMarker);
                        }
                        if (existingCell.hasSlowMarker) {
                            const slowMarker = document.createElement('div');
                            slowMarker.className = 'slow-marker';
                            slowMarker.textContent = '!';
                            cell.appendChild(slowMarker);
                        }
                        if (existingCell.hasDuelistMarker) {
                            const duelistMarker = document.createElement('div');
                            duelistMarker.className = 'duelist-marker';
                            duelistMarker.textContent = 'F';
                            cell.appendChild(duelistMarker);
                        }
                        if (existingCell.hasEyesMarker) {
                            const eyesMarker = document.createElement('div');
                            eyesMarker.className = 'eyes-marker';
                            eyesMarker.textContent = 'ğŸ‘';
                            cell.appendChild(eyesMarker);
                        }
                        if (existingCell.hasBushImage) {
                            const bushImage = document.createElement('div');
                            bushImage.className = 'bush-image';
                            cell.appendChild(bushImage);
                        }
                        if (existingCell.hasDuelistImage) {
                            const duelistImage = document.createElement('div');
                            duelistImage.className = 'duelist-image';
                            cell.appendChild(duelistImage);
                        }
                        if (existingCell.hasEyesImage) {
                            const eyesImage = document.createElement('div');
                            eyesImage.className = 'eyes-image';
                            cell.appendChild(eyesImage);
                        }
                    }

                    grid.appendChild(cell);
                }
            }
        }

        // æ›´æ–°ç½‘æ ¼æ¨¡æ¿å’Œé‡æ–°æ’åˆ—å•å…ƒæ ¼
        switch(direction) {
            case 'top':
            case 'bottom':
                grid.style.gridTemplateRows = `repeat(${rows + 1}, 1fr)`;
                break;
            case 'left':
            case 'right':
                grid.style.gridTemplateColumns = `repeat(${cols + 1}, 1fr)`;
                break;
        }

        reorderCells();

        // æ›´æ–°èµ·ç‚¹ç»ˆç‚¹çŠ¶æ€
        if (mapState.start) {
            switch(direction) {
                case 'top':
                    mapState.start.y++;
                    break;
                case 'left':
                    mapState.start.x++;
                    break;
            }
        }
        if (mapState.end) {
            switch(direction) {
                case 'top':
                    mapState.end.y++;
                    break;
                case 'left':
                    mapState.end.x++;
                    break;
            }
        }
    }
    function locatePoints() {
        const grid = document.getElementById('grid');
        const rows = parseInt(grid.style.gridTemplateRows.match(/repeat\((\d+)/)[1]);

        // è·å–è¾“å…¥çš„åæ ‡
        const startInput = document.getElementById('startCoord').value;
        const endInput = document.getElementById('endCoord').value;

        // è§£æåæ ‡
        const startMatch = startInput.match(/\((\d+),(\d+)\)/);
        const endMatch = endInput.match(/\((\d+),(\d+)\)/);

        if (startMatch) {
            const [_, inputX, inputY] = startMatch;
            // æ¸…é™¤æ—§çš„èµ·ç‚¹
            if (mapState.start) {
                const oldStart = document.querySelector(`[data-x="${mapState.start.x}"][data-y="${mapState.start.y}"]`);
                if (oldStart) {
                    oldStart.dataset.state = 'wall';
                    oldStart.className = 'cell wall';
                    oldStart.textContent = '';
                }
            }

            // æ ¹æ®å½“å‰çš„åæ ‡ç³»ç»Ÿè½¬æ¢
            const x = parseInt(inputX);
            const y = rows - 1 - parseInt(inputY);

            // è®¾ç½®æ–°çš„èµ·ç‚¹
            const startCell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
            if (startCell) {
                startCell.dataset.state = 'start';
                startCell.className = 'cell start';
                startCell.textContent = 'S';
                mapState.start = {x: x, y: y};
            }
        }

        if (endMatch) {
            const [_, inputX, inputY] = endMatch;
            // æ¸…é™¤æ—§çš„ç»ˆç‚¹
            if (mapState.end) {
                const oldEnd = document.querySelector(`[data-x="${mapState.end.x}"][data-y="${mapState.end.y}"]`);
                if (oldEnd) {
                    oldEnd.dataset.state = 'wall';
                    oldEnd.className = 'cell wall';
                    oldEnd.textContent = '';
                }
            }

            // æ ¹æ®å½“å‰çš„åæ ‡ç³»ç»Ÿè½¬æ¢
            const x = parseInt(inputX);
            const y = rows - 1 - parseInt(inputY);

            // è®¾ç½®æ–°çš„ç»ˆç‚¹
            const endCell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
            if (endCell) {
                endCell.dataset.state = 'end';
                endCell.className = 'cell end';
                endCell.textContent = 'E';
                mapState.end = {x: x, y: y};
            }
        }
    }
    function disableOtherButtons(exceptId) {
        const buttons = document.querySelectorAll('.tag-group button');
        buttons.forEach(button => {
            if (button.id !== exceptId) {
                button.disabled = true;
                button.style.opacity = 0.5;
            }
        });
    }
    function enableAllButtons() {
        const buttons = document.querySelectorAll('.tag-group button');
        buttons.forEach(button => {
            button.disabled = false;
            button.style.opacity = 1;
        });
    }
    function toggleSlowMode() {
        slowMode = !slowMode;
        const button = document.getElementById('slowModeToggle');
        button.textContent = slowMode ? 'é€€å‡ºæ…¢è¡Œæ¨¡å¼' : 'æ…¢è¡Œæ¨¡å¼';
        if (slowMode) {
            disableOtherButtons('slowModeToggle');
        } else {
            enableAllButtons();
        }
    }
    function toggleBushMode() {
        bushMode = !bushMode;
        const button = document.getElementById('bushModeToggle');
        button.textContent = bushMode ? 'é€€å‡ºè‰ä¸›æ¨¡å¼' : 'è‰ä¸›æ¨¡å¼';
        if (bushMode) {
            disableOtherButtons('bushModeToggle');
        } else {
            enableAllButtons();
        }
    }
    function toggleDuelistMode() {
        duelistMode = !duelistMode;
        const button = document.getElementById('duelistModeToggle');
        button.textContent = duelistMode ? 'é€€å‡ºå†³æ–—è€…æ¨¡å¼' : 'å†³æ–—è€…æ¨¡å¼';
        if (duelistMode) {
            disableOtherButtons('duelistModeToggle');
        } else {
            enableAllButtons();
        }
    }
    function toggleEyesMode() {
        eyesMode = !eyesMode;
        const button = document.getElementById('eyesModeToggle');
        button.textContent = eyesMode ? 'é€€å‡ºçœ¼ç›æ¨¡å¼' : 'çœ¼ç›æ¨¡å¼';
        if (eyesMode) {
            disableOtherButtons('eyesModeToggle');
        } else {
            enableAllButtons();
        }
    }
    // åˆå§‹åŒ–é»˜è®¤ç½‘æ ¼
    initGrid();
</script>
</body>
</html>